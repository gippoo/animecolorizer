<!DOCTYPE html>
<html>
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.1/p5.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.1/addons/p5.dom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.12.0"> </script>
</head>
<body>
<h1>Anime Colorizer</h1>
<h2>Load an image then click colorize to have the computer color the image.</h2>
<h3>Some images may not load due to cross-origin restrictions. If the image doesn't load in a few seconds, try another one.</h3>
<h4>There may be issues on a mobile device.</h4>
	
<div id="canholder">
</div>

<script>

async function init() {
	blueC = await tf.loadModel('https://gippoo.github.io/animecolorizer/blue/model.json');
	blondeC = await tf.loadModel('https://gippoo.github.io/animecolorizer/blonde/model.json');
	redC = await tf.loadModel('https://gippoo.github.io/animecolorizer/red/model.json');
	greenC = await tf.loadModel('https://gippoo.github.io/animecolorizer/green/model.json');
	//purpleC = await tf.loadModel('https://gippoo.github.io/animecolorizer/purple/model.json');
}

init();


var inp;
var grayscale = [];
var b1;
var randColor = 0;
var prediction;
var inputImg;
var outputImg;
var colordata = [];
var imgLoaded = false;

function setup() {
	inp = createInput();
	b1 = createButton('Colorize');
	var canv = createCanvas(288, 144);
	canv.parent("canholder");
	inp.parent("things");
	b1.parent("things");
	inp.elt.placeholder = "Paste URL Here";
	inp.elt.spellcheck = false;
	background(255);
	inp.size(300, 15);
	b1.mousePressed(colorize);
}


function imageLoader() {
	var link = inp.value();
	inputImg = loadImage(link, function(img) {
		imgLoaded = true;
		document.getElementById("result").innerHTML = "LEFT = Original, RIGHT = Colorized";
	}, function() {
		document.getElementById("result").innerHTML = "Failed to Load";
		imgLoaded = false;
	});
}

function getGSData() {
	inputImg.resize(96,96);
	inputImg.loadPixels();
	grayscale = [];
	
	for (let i = 0; i < inputImg.pixels.length; i += 4) {
		let lValue = 0.3 * inputImg.pixels[i] + 0.6 * inputImg.pixels[i+1] + 0.1 * inputImg.pixels[i+2];
		grayscale.push(1-lValue/255);
	}
	
	push();
	scale(1.5);
	image(inputImg, 0, 0);
	pop();
}

function getOutput() {
	tf.tidy(() => {
		var inputs = tf.tensor4d(grayscale,[1,96,96,1]);
		if (randColor == 0) {
			prediction = blueC.predict(inputs);
		} else if (randColor == 1) {
			prediction = redC.predict(inputs);
		} else if (randColor == 2) {
			prediction = greenC.predict(inputs);
		} else if (randColor == 3) {
			prediction = blondeC.predict(inputs);
		}

		prediction = prediction.flatten().dataSync();
	}); 

	colordata = [];
	
	for (let i = 0; i < prediction.length; i += 3) {
		colordata.push(Math.floor(prediction[i]*255));
		colordata.push(Math.floor(prediction[i+1]*255));
		colordata.push(Math.floor(prediction[i+2]*255));
		colordata.push(255);
		}
	
	outputImg = inputImg;
	outputImg.loadPixels();
	
	for (let i = 0; i < outputImg.pixels.length; i += 4) {
		outputImg.pixels[i] = colordata[i];
		outputImg.pixels[i+1] = colordata[i+1];
		outputImg.pixels[i+2] = colordata[i+2];
	}
	
	outputImg.updatePixels();
}

function displayFinal() {
	push();
	scale(1.5);
	image(outputImg, 96, 0);
	pop();
}


function colorize() {
	imageLoader();
	
	setTimeout(function() {
		if (imgLoaded) {
			getGSData();
			randColor = Math.floor(Math.random() * 4);
			getOutput();
			displayFinal();
		}
	}, 1000);
}


</script>

<p id="result"></p>
<p id="things"></p>
<p>Sample URLs: https://gippoo.github.io/animecolorizer/danbooru_2635681_b6f432873bff434074c912cc851f59e2.jpg</p>

</body>
</html>
